<?xml version="1.0" encoding="UTF-8"?>
<entity-mappings xmlns="http://xmlns.jcp.org/xml/ns/persistence/orm"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence/orm http://xmlns.jcp.org/xml/ns/persistence/orm_2_0.xsd"
                 version="2.1">

    <named-native-query name="User.listRolesByUserId"
                        result-class="net.evecom.common.usms.entity.RoleEntity">
        <query>
            select * from usms_roles r where r.id in
            (select ur.role_id from usms_user_role ur where ur.user_id = ?)
            and r.enabled = 1
        </query>
    </named-native-query>

    <named-native-query name="User.listOpersByUserId"
                        result-class="net.evecom.common.usms.entity.OperationEntity">
        <query>
            select * from usms_operations o where o.id in
            (select po.oper_id from usms_privilege_operation po
            where po.priv_id in
            (select p.id from usms_privileges p where p.id in
            (select pr.priv_id from usms_privilege_role pr, usms_roles r
            where pr.role_id in
            (select ur.role_id from usms_user_role ur where ur.user_id = ?)
            and pr.role_id = r.id and r.enabled = 1)
            and p.enabled = 1))
            and o.enabled = 1
        </query>
    </named-native-query>

    <named-native-query name="User.listAppsByUserId"
                        result-class="net.evecom.common.usms.entity.ApplicationEntity">
        <query>
            select * from usms_applications a where a.id in (
            select distinct o.application_id from usms_operations o
            where o.id in (select po.oper_id
            from usms_privilege_operation po
            where po.priv_id in
            (select p.id from usms_privileges p
            where p.id in (select pr.priv_id
            from usms_privilege_role pr, usms_roles r
            where pr.role_id in
            (select ur.role_id from usms_user_role ur where ur.user_id = ?)
            and pr.role_id = r.id and r.enabled = 1)
            and p.enabled = 1)) and o.enabled = 1 and o.application_id is not null)
        </query>
    </named-native-query>

    <named-native-query name="User.listGridsByLoginName"
                        result-class="net.evecom.common.usms.entity.GridEntity">
        <query>
            select * from gsmp_loc_grids g
            where g.code in
            (select ug.grid_code from usms_user_grid ug
            where ug.user_id =
            (select u.id from usms_users u where u.login_name = ?))
        </query>
    </named-native-query>

    <named-native-query name="User.listInstsByUserId"
                        result-class="net.evecom.common.usms.entity.InstitutionEntity">
        <query>
            select * from usms_institutions i where i.id in
            (select ui.institution_id from usms_user_institution ui where ui.user_id = ?)
        </query>
    </named-native-query>

    <named-native-query name="User.listTargetRoles"
                        result-class="net.evecom.common.usms.entity.RoleEntity">
        <query>
            select * from usms_roles where id in
            (select role_id from usms_user_role where user_id = ?) and enabled=1
        </query>
    </named-native-query>

    <named-native-query name="User.listSourceRoles"
                        result-class="net.evecom.common.usms.entity.RoleEntity">
        <query>
            select * from usms_roles where id not in
            (select role_id from usms_user_role where user_id = ?) and enabled=1
        </query>
    </named-native-query>


</entity-mappings>

